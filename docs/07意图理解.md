# Text2SQL 意图理解详解

## 概述

本文档详细说明了Text2SQL应用中的意图理解流程，包括如何判断用户意图是否明确，以及如何通过反问来完善用户意图。

---

## 1. 意图理解流程

根据流程图设计，意图理解流程如下：

```
用户提问 → LLM分析意图 → 判断意图是否明确
                              ↓
                    明确 → 提取意图 → 进入RAG阶段
                              ↓
                    不明确 → 生成澄清问题 → 用户回答 → 合并上下文 → 重新分析
```

### 关键点

- **LLM需要返回两个信息**：意图是否明确 + 澄清问题（如果不明确）
- **保存对话历史**：每次都把完整上下文发给LLM
- **循环过程**：直到意图明确为止（建议设置最大澄清轮次2-3轮）

---

## 2. 意图明显 vs 意图不明显

### 2.1 意图明显的问题

这些问题包含了SQL生成所需的**完整要素**：

| 要素 | 说明 |
|------|------|
| **明确的查询对象** | 航班、会员、订单等 |
| **明确的时间范围** | 具体日期或相对时间 |
| **明确的筛选条件** | 航班号、会员等级等 |
| **明确的输出要求** | 详细信息、统计数据、排名等 |

#### 示例

**示例1：查询特定航班**
```
✅ "查询航班号CA1519在2025年6月1日的详细信息"
   - 对象：航班
   - 时间：2025年6月1日
   - 条件：航班号CA1519
   - 输出：详细信息
```

**示例2：统计会员数据**
```
✅ "统计过去30天内有过消费记录的活跃会员数量"
   - 对象：会员
   - 时间：过去30天
   - 条件：有消费记录
   - 输出：数量统计
```

**示例3：查询天气预警**
```
✅ "列出广东省当前所有正在生效的红色和橙色级别的天气预警"
   - 对象：天气预警
   - 时间：当前
   - 条件：广东省 + 红色/橙色级别 + 正在生效
   - 输出：列表
```

### 2.2 意图不明显的问题

这些问题**缺少关键要素**或**存在歧义**：

#### 类型1：缺少时间范围

```
❌ "查询航班号CA1519的详细信息"
   问题：哪一天的？历史所有的？最近一次的？

需要澄清：
   - 您想查询哪一天的航班信息？
   - 或者您想查询最近一次的CA1519航班？
```

#### 类型2：缺少筛选条件

```
❌ "查询会员的消费情况"
   问题：所有会员？哪个等级？哪个时间段？

需要澄清：
   - 您想查询哪些会员的消费情况？（所有会员/特定等级/特定会员）
   - 时间范围是？（最近一个月/一年/全部历史）
```

#### 类型3：输出要求不明确

```
❌ "看一下航班延误情况"
   问题：要统计数据？详细列表？延误原因分析？

需要澄清：
   - 您想看延误航班的详细列表，还是延误统计数据？
   - 时间范围是？
```

#### 类型4：存在歧义

```
❌ "查询会员消费"
   歧义：
   - 会员的消费记录？
   - 会员的消费总额？
   - 会员的消费次数？

需要澄清：
   - 您想查看会员的消费记录明细，还是消费金额统计？
```

#### 类型5：专业术语不清晰

```
❌ "查询准点率"
   问题：哪个航空公司？哪个时间段？哪个航站楼？

需要澄清：
   - 您想查询哪个维度的准点率？（航空公司/航站楼/整体）
   - 时间范围是？
```

---

## 3. 如何判断意图是否清晰

需要让LLM进行**结构化判断**，建议使用以下Prompt模板：

### 3.1 意图分析Prompt模板

```python
INTENT_ANALYSIS_PROMPT = """
你是一个Text2SQL系统的意图分析专家。请分析用户问题是否包含生成SQL所需的完整信息。

用户问题：{user_question}

请按以下维度判断：

1. **查询对象**：是否明确要查询什么？（航班/会员/订单/天气等）
   - 明确 / 不明确

2. **时间范围**：是否指定了时间范围？
   - 明确（如：2025年6月1日、过去30天）
   - 不明确（缺少时间）
   - 不需要（如：查询表结构）

3. **筛选条件**：是否有足够的筛选条件？
   - 明确（如：航班号CA1519、VIP会员）
   - 不明确（条件不足）
   - 不需要（如：查询所有）

4. **输出要求**：是否明确要什么样的结果？
   - 明确（如：详细信息、统计数量、排名TOP10）
   - 不明确（不知道要什么格式）

请以JSON格式返回：
{{
  "is_clear": true/false,
  "missing_elements": ["时间范围", "筛选条件"],  // 如果不明确，列出缺失的要素
  "clarification_questions": [
    "您想查询哪一天的航班信息？",
    "或者您想查询最近一次的CA1519航班？"
  ]
}}
"""
```

### 3.2 判断逻辑

```python
def is_intent_clear(analysis_result):
    """
    只有当所有必需要素都明确时，才认为意图清晰
    """
    return (
        analysis_result["is_clear"] == True and
        len(analysis_result["missing_elements"]) == 0
    )
```

---

## 4. 如何反问用户完善意图

### 4.1 反问策略

#### 策略1：提供选项（推荐）

```
用户："查询航班号CA1519的详细信息"

反问：
"请问您想查询哪一天的CA1519航班？
1. 今天（2026年2月9日）
2. 最近一次航班
3. 指定日期（请输入日期）"
```

#### 策略2：引导式提问

```
用户："看一下会员消费情况"

反问：
"为了更准确地查询，请补充以下信息：
1. 查询哪些会员？（所有会员/VIP会员/指定会员）
2. 时间范围？（最近一个月/最近一年/全部历史）
3. 需要什么信息？（消费明细/消费总额/消费次数）"
```

#### 策略3：结合业务场景

```
用户："查询准点率"

反问：
"准点率统计有多个维度，请选择：
1. 按航空公司统计（如：东航、南航的准点率对比）
2. 按航站楼统计（如：T1、T2的准点率对比）
3. 整体准点率
时间范围：（今天/本周/本月/自定义）"
```

### 4.2 澄清问题Prompt模板

```python
CLARIFICATION_PROMPT = """
用户问题不够明确，缺少以下要素：{missing_elements}

原始问题：{user_question}

请生成友好的澄清问题，帮助用户补充信息。要求：
1. 使用选项式提问（提供2-4个常见选项）
2. 结合民航机场业务场景
3. 语气友好、专业
4. 如果可能，提供默认选项（如"今天"、"最近一次"）

请以JSON格式返回：
{{
  "clarification_message": "为了更准确地查询，请补充以下信息：",
  "questions": [
    {{
      "question": "查询哪一天的航班？",
      "options": ["今天（2026年2月9日）", "最近一次航班", "指定日期"],
      "default": "今天（2026年2月9日）"
    }}
  ]
}}
"""
```

### 4.3 LangGraph实现示例

```python
def intent_understanding_node(state):
    """
    意图理解节点
    """
    user_question = state["user_question"]
    conversation_history = state.get("conversation_history", [])

    # 1. 分析意图
    analysis = llm.invoke(
        INTENT_ANALYSIS_PROMPT.format(
            user_question=user_question,
            conversation_history=conversation_history
        )
    )

    # 2. 判断是否清晰
    if analysis["is_clear"]:
        return {
            "intent": analysis["intent"],
            "next_stage": "rag_retrieval"  # 进入RAG阶段
        }
    else:
        # 3. 生成澄清问题
        clarification = llm.invoke(
            CLARIFICATION_PROMPT.format(
                missing_elements=analysis["missing_elements"],
                user_question=user_question
            )
        )

        return {
            "clarification_needed": True,
            "clarification_questions": clarification["questions"],
            "next_stage": "wait_for_user_response"  # 等待用户回答
        }
```

---

## 5. 总结

| 问题 | 核心要点 |
|------|----------|
| **意图理解流程** | LLM分析 → 判断是否明确 → 明确则进入RAG / 不明确则生成澄清问题 → 循环 |
| **意图明显** | 包含完整要素：查询对象 + 时间范围 + 筛选条件 + 输出要求 |
| **意图不明显** | 缺少关键要素或存在歧义（5种类型） |
| **判断方法** | 让LLM进行结构化判断（4个维度），返回JSON格式 |
| **反问策略** | 提供选项式提问（推荐）、引导式提问、结合业务场景 |

---

## 6. 下一步建议

1. **构建测试用例**：根据MRD中的常见问题，构建意图分析的测试用例
2. **设计模板库**：针对民航场景设计澄清问题的模板库
3. **实现意图理解节点**：在LangGraph中实现意图理解节点
4. **设置最大澄清轮次**：建议2-3轮，避免无限循环
5. **优化用户体验**：提供快捷选项，减少用户输入负担

---

## 7. 常见问题示例分析

基于MRD中的常见问题，进行意图分析：

| 用户问题 | 意图是否明确 | 分析 |
|---------|-------------|------|
| "查询航班号CA1519在2025年6月1日的详细信息" | ✅ 明确 | 包含所有要素 |
| "查看每位会员在最近一年内的消费总金额和消费次数统计" | ✅ 明确 | 包含所有要素 |
| "找出2月份过生日的所有白名单会员" | ✅ 明确 | 包含所有要素 |
| "统计过去30天内有过消费记录的活跃会员数量" | ✅ 明确 | 包含所有要素 |
| "列出广东省当前所有正在生效的红色和橙色级别的天气预警" | ✅ 明确 | 包含所有要素 |
| "查询航班延误情况" | ❌ 不明确 | 缺少时间范围、输出要求 |
| "看一下会员消费" | ❌ 不明确 | 缺少时间范围、筛选条件、输出要求 |
| "查询准点率" | ❌ 不明确 | 缺少维度（航空公司/航站楼）、时间范围 |
