version: '3.8'

networks:
  chat-bi-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local

services:
  # MySQL 8 数据库服务
  mysql:
    restart: always
    networks:
      - chat-bi-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$MYSQL_ROOT_PASSWORD"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    image: mysql:8.4.0
    container_name: chat-bi-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-Admin123!@#}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-chat_bi}
      MYSQL_USER: ${MYSQL_USER:-chat_bi_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-ChatBi123!@#}
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    volumes:
      - mysql-data:/var/lib/mysql
      - ./docker/init/mysql:/docker-entrypoint-initdb.d
      - ./dataset:/docker-entrypoint-initdb.d/dataset:ro
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max_connections=1000
      - --wait_timeout=3600
      - --interactive_timeout=3600
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: '4G'

  # Redis 7 缓存服务
  redis:
    restart: always
    networks:
      - chat-bi-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    image: redis:7.4.0
    container_name: chat-bi-redis
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD:-Redis123!@#}
    volumes:
      - redis-data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command:
      - redis-server
      - --requirepass ${REDIS_PASSWORD:-Redis123!@#}
      - --appendonly yes
      - --appendfsync everysec
      - --maxmemory 1G
      - --maxmemory-policy allkeys-lru
      - --rename-command FLUSHDB ""
      - --rename-command FLUSHALL ""
      - --rename-command KEYS ""
      - --rename-command CONFIG ""
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: '2G'

  # 应用服务
  app:
    restart: always
    networks:
      - chat-bi-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    build:
      context: .
      dockerfile: docker/build/Dockerfile
    container_name: chat-bi-app
    environment:
      # 数据库配置
      DATABASE_URL: mysql+pymysql://${MYSQL_USER:-chat_bi_user}:${MYSQL_PASSWORD:-ChatBi123!@#}@mysql:3306/${MYSQL_DATABASE:-chat_bi}?charset=utf8mb4
      
      # Redis配置
      REDIS_URL: redis://:${REDIS_PASSWORD:-Redis123!@#}@redis:6379/0
      
      # 应用配置
      APP_ENV: ${APP_ENV:-production}
      APP_PORT: 8000
      APP_HOST: 0.0.0.0
      
      # LLM配置
      OLLAMA_HOST: ${OLLAMA_HOST:-http://host.docker.internal:11434}
    volumes:
      - .:/app:cached
    ports:
      - "${APP_PORT:-8000}:8000"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: '8G'

  # 初始化服务（仅运行一次）
  init-db:
    restart: "no"
    networks:
      - chat-bi-network
    image: mysql:8.4.0
    container_name: chat-bi-init-db
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-Admin123!@#}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-chat_bi}
    volumes:
      - ./dataset:/dataset:ro
      - ./docker/init/mysql:/docker-entrypoint-initdb.d:ro
    depends_on:
      mysql:
        condition: service_healthy
    command:
      - /bin/bash
      - -c
      - |
        echo "等待MySQL就绪..."
        sleep 10
        echo "开始初始化数据库..."
        mysql -h mysql -u root -p$MYSQL_ROOT_PASSWORD $MYSQL_DATABASE << 'EOF'
        -- 创建数据库（如果不存在）
        CREATE DATABASE IF NOT EXISTS $MYSQL_DATABASE CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
        USE $MYSQL_DATABASE;
        
        -- 执行航班数据DDL
        source /dataset/航班数据DDL.sql;
        
        -- 执行其他DDL脚本（如果需要）
        source /dataset/会员商业数据DDL.sql;
        source /dataset/天气数据DDL.sql;
        source /dataset/机场静态资源数据DDL.sql;
        
        echo "数据库初始化完成！"
        EOF