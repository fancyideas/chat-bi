
-- 查询所有白名单会员的基本信息（含姓名、手机号、邮箱、出生日期）
SELECT 
    CRM_VIP_VIPCODE AS 会员号,
    CRM_VIP_SURNAME AS 姓名,
    CRM_VIP_DEFAULTMOBILE AS 手机号,
    CRM_VIP_VIPEMAILVARCHAR2 AS 邮箱,
    CRM_VIP_BIRTHDAY AS 生日
FROM DW_CRM_VIP
WHERE CRM_VIP_ACTIVE = '1'  -- 白名单
  AND DELETE_FLAG = 0;
  
-- 统计每位会员近一年的总消费金额和消费次数
SELECT 
    s.CRM_SELL_VIPCODE AS 会员号,
    COUNT(*) AS 消费次数,
    SUM(CAST(s.CRM_SELL_NETAMOUNT AS DECIMAL(18,2))) AS 总消费金额
FROM DW_CRM_TRANSSALESTOTAL s
WHERE s.DELETE_FLAG = 0
  AND s.CRM_SELL_TXDATE >= '2024-09-03'
GROUP BY s.CRM_SELL_VIPCODE;

-- 查询本月生日的白名单会员
SELECT 
    v.CRM_VIP_VIPCODE AS 会员号,
    v.CRM_VIP_SURNAME AS 姓名,
    v.CRM_VIP_DEFAULTMOBILE AS 手机号,
    v.CRM_VIP_BIRTHDAY AS 完整生日,
    v.CRM_VIP_CONSTELLATION AS 星座
FROM DW_CRM_VIP v
WHERE v.CRM_VIP_ACTIVE = '1'
  AND v.DELETE_FLAG = 0
  AND v.CRM_VIP_BIRTHDAYMM = '02'; -- 2月生日（实际查询时需要加密）
  
-- 关联查询：会员基本信息 + 最近一次消费记录
SELECT 
    v.CRM_VIP_VIPCODE AS 会员号,
    v.CRM_VIP_SURNAME AS 姓名,
    v.CRM_VIP_SEX AS 性别,
    v.CRM_VIP_SHENG AS 省,
    v.CRM_VIP_SHI AS 市,
    s.CRM_SELL_TXDATETIME AS 最近消费时间,
    s.CRM_SELL_NETAMOUNT AS 最近消费金额,
    s.CRM_SELL_STOREID AS 消费店铺
FROM DW_CRM_VIP v
LEFT JOIN (
    SELECT 
        CRM_SELL_VIPCODE,
        CRM_SELL_TXDATETIME,
        CRM_SELL_NETAMOUNT,
        CRM_SELL_STOREID,
        ROW_NUMBER() OVER (PARTITION BY CRM_SELL_VIPCODE ORDER BY CRM_SELL_TXDATETIME DESC) AS rn
    FROM DW_CRM_TRANSSALESTOTAL
    WHERE DELETE_FLAG = 0
) s ON v.CRM_VIP_VIPCODE = s.CRM_SELL_VIPCODE AND s.rn = 1
WHERE v.DELETE_FLAG = 0;

-- 查询最近30天有消费记录的活跃会员数
SELECT COUNT(DISTINCT CRM_SELL_VIPCODE) AS 活跃会员数
FROM DW_CRM_TRANSSALESTOTAL
WHERE CRM_SELL_TXDATETIME >= TO_CHAR(CURRENT_DATE - 30, 'YYYY-MM-DD')
  AND DELETE_FLAG = 0;
  
-- 列出所有仍在营业的餐饮店铺及其所在区域
SELECT 
    b.BSN_RES_SHOPNAME AS 店铺名称,
    a.BSN_RES_AREANAME AS 所在区域,
    b.BSN_RES_TERMINALFLOOR AS 楼层
FROM DW_BSN_RES b
LEFT JOIN DW_CATER_AREA a ON b.BSN_RES_AID = a.BSN_RES_AID
WHERE b.BSN_RES_ACTIVE = '1'
  AND b.BSN_RES_BEOPEN = 1
  AND b.DELETE_FLAG = 0
  AND b.MALLID = 'CY';
  
-- 按店铺统计2025年总销售额（仅限有效店铺）
SELECT 
    s.CRM_SELL_STOREID AS 店铺编号,
    b.BSN_RES_SHOPNAME AS 店铺名称,
    SUM(CAST(s.CRM_SELL_NETAMOUNT AS DECIMAL(18,2))) AS 总销售额
FROM DW_CRM_TRANSSALESTOTAL s
JOIN DW_BSN_RES b ON s.CRM_SELL_STOREID = b.BSN_RES_SHOPCODE
WHERE SUBSTR(s.CRM_SELL_TXDATE, 1, 4) = '2025'
  AND s.DELETE_FLAG = 0
  AND b.BSN_RES_ACTIVE = '1'
  AND b.DELETE_FLAG = 0
GROUP BY s.CRM_SELL_STOREID, b.BSN_RES_SHOPNAME
ORDER BY 总销售额 DESC;